// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  admin
  member
}

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  passwordHash String?
  displayName  String?
  isOwner      Boolean      @default(false)
  createdAt    DateTime     @default(now())
  memberships  Membership[]
  ownedLeagues League[]     @relation("LeagueOwner")
  ownedTeams   Team[]       @relation("TeamOwner")
}

model League {
  id          String      @id @default(cuid())
  name        String
  ownerUserId String
  inviteCode  String      @unique
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  owner       User        @relation("LeagueOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
  teams       Team[]
  memberships Membership[]
  draftState  DraftState?
}

model Team {
  id          String       @id @default(cuid())
  leagueId    String
  slotNumber  Int
  name        String
  ownerUserId String?
  createdAt   DateTime     @default(now())

  league      League       @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  owner       User?        @relation("TeamOwner", fields: [ownerUserId], references: [id], onDelete: SetNull)
  memberships Membership[]

  @@unique([leagueId, slotNumber])
}

model Membership {
  id        String   @id @default(cuid())
  leagueId  String
  userId    String
  role      Role
  teamId    String?
  createdAt DateTime @default(now())

  league    League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@unique([leagueId, userId])
}

model DraftState {
  id                    String   @id @default(cuid())
  leagueId              String   @unique
  assignmentByPlayerId  Json     @default("{}")
  pickOrderByPlayerId   Json     @default("{}")
  eliminationByPlayerId Json     @default("{}")
  draftOrderTeamIds     Json     @default("[]")
  currentPickIndex      Int      @default(0)
  roundNumber           Int      @default(1)
  direction             Int      @default(1)
  isDraftActive         Boolean  @default(false)
  tribes                Json     @default("[]")
  tribeByPlayerId       Json     @default("{}")
  updatedAt             DateTime @updatedAt

  league                League   @relation(fields: [leagueId], references: [id], onDelete: Cascade)
}

model Player {
  id            String   @id
  name          String
  photoUrl      String
  age           Int?
  tribe         String?
  eliminated    Int?
  seasons       Json     @default("[]")
  seasonCount   Int      @default(0)
  winnerCount   Int      @default(0)
  finalistCount Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  seasonsPlayed PlayerSeason[]
  advantageLinks AdvantagePlayer[]
}

model Advantage {
  advantageID String   @id
  name        String   @unique
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  playerLinks AdvantagePlayer[]
}

model AdvantagePlayer {
  advantageID String
  playerId    String
  status      String   @default("HOLDS")
  createdAt   DateTime @default(now())

  advantage   Advantage @relation(fields: [advantageID], references: [advantageID], onDelete: Cascade)
  player      Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@id([advantageID, playerId])
  @@index([playerId])
}

model Tribe {
  id        String   @id
  name      String   @unique
  color     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PlayerSeason {
  id           String   @id @default(cuid())
  playerId     String
  seasonLabel  String
  seasonNumber Int?
  placement    Int?
  advantagesFound        Int?
  daysPlayed             Int?
  tribalChallengeWinPct  Float?
  individualImmunityWins Int      @default(0)
  individualRewardWins   Int      @default(0)
  createdAt    DateTime @default(now())

  player       Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([playerId, seasonLabel])
}
